
<!DOCTYPE html>
<html>
<head>
	<title>Channel Settings</title>
	<script src="/socket.io/socket.io.js"></script>
	<style>
		body { font-family: sans-serif; background: #f0f0f0; margin: 0; padding: 0; }
		.container { max-width: 400px; margin: 40px auto; background: #fff; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.08); padding: 2rem; }
		h2 { text-align: center; }
		.channels-list { list-style: none; padding: 0; }
		.channels-list li { margin: 0.5rem 0; }
		button { margin-top: 1rem; width: 100%; padding: 0.75rem; background: #333; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
		.status { text-align: center; margin-top: 1rem; color: green; }
		.error { color: red; }
	</style>
</head>
<body>
	<div class="container">
		<h2>Channel Subscriptions</h2>
		<form id="channels-form">
			<div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
				<input id="new-channel" type="text" placeholder="Add channel (e.g. my-friends-room)" maxlength="32" style="flex:1;" />
				<button type="button" id="add-channel">Add</button>
			</div>
			<ul class="channels-list" id="channels-list"></ul>
			<button type="submit">Save Preferences</button>
		</form>
		<div class="status" id="status"></div>
		<a href="/">Back to Chat</a>
	</div>
	<script>
		const socket = io();
		let subscribedChannels = [];
		const channelsList = document.getElementById('channels-list');
		const statusDiv = document.getElementById('status');
		const newChannelInput = document.getElementById('new-channel');
		const addChannelBtn = document.getElementById('add-channel');

		// Render channel list with remove buttons
		function renderChannels() {
			channelsList.innerHTML = '';
			subscribedChannels.forEach(channel => {
				const li = document.createElement('li');
				li.textContent = channel;
				if (channel !== 'general') {
					const removeBtn = document.createElement('button');
					removeBtn.textContent = 'Remove';
					removeBtn.style.marginLeft = '1rem';
					removeBtn.onclick = () => {
						subscribedChannels = subscribedChannels.filter(c => c !== channel);
						renderChannels();
					};
					li.appendChild(removeBtn);
				} else {
					li.style.fontWeight = 'bold';
				}
				channelsList.appendChild(li);
			});
		}

		// Receive channel info from server
		socket.on('channel info', data => {
			subscribedChannels = data.subscribed;
			renderChannels();
		});

		// Show errors
		socket.on('error', msg => {
			statusDiv.textContent = msg;
			statusDiv.className = 'status error';
		});

		// Add channel button
		addChannelBtn.onclick = () => {
			const val = newChannelInput.value.trim();
			if (val.length === 0 || val.length > 32 || !/^[a-zA-Z0-9_-]+$/.test(val)) {
				statusDiv.textContent = 'Invalid channel name. Use 1-32 letters, numbers, - or _.';
				statusDiv.className = 'status error';
				return;
			}
			if (!subscribedChannels.includes(val)) {
				subscribedChannels.push(val);
				renderChannels();
				statusDiv.textContent = '';
			}
			newChannelInput.value = '';
		};

		// On form submit, send new subscriptions
		document.getElementById('channels-form').addEventListener('submit', e => {
			e.preventDefault();
			if (!subscribedChannels.includes('general')) subscribedChannels.push('general');
			socket.emit('subscribe channels', subscribedChannels);
			statusDiv.textContent = 'Preferences saved!';
			statusDiv.className = 'status';
		});
	</script>
</body>
</html>
